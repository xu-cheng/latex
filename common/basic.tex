% Check for obsoleted LaTeX packages
\RequirePackage[l2tabu,orthodox]{nag}

% Utility packages
\RequirePackage{datenumber}
\RequirePackage{etoolbox}
\RequirePackage{iftex}
\RequirePackage{ragged2e}
\RequirePackage{regexpatch}
\RequirePackage{xifthen}
\RequirePackage{xstring}

% Font setting
\ifLuaTeX%
    \RequirePackage{fontspec}
    \setmainfont[Ligatures={Common,TeX}]{Tex Gyre Termes}
    \setsansfont[Ligatures={Common,TeX}]{Helvetica Neue}
    \setmonofont{CMU Typewriter Text}
    \defaultfontfeatures{Scale=MatchLowercase}
\else%
    \RequirePackage{newtxtext}
    \RequirePackage[T1]{fontenc}
    \RequirePackage{textcomp}
\fi%

% Paper size setting
\ifthenelse{\isnamedefined{pagewidth}}{
    \pagewidth=\paperwidth%
    \pageheight=\paperheight%
}{
    \ifthenelse{\isnamedefined{pdfpagewidth}}{
        \pdfpagewidth=\paperwidth%
        \pdfpageheight=\paperheight%
    }{}
}

% Indent of paragraph and skip between paragraphs
\RequirePackage{indentfirst}
\setlength{\parindent}{2em}
\setlength{\parskip}{0pt plus 2pt}

% Color packages
\RequirePackage{color}
\RequirePackage[table,dvipsnames]{xcolor}

% hyperref setting
\RequirePackage[unicode]{hyperref}
\definecolor{@hyperreflinkred}{RGB}{128,23,31}
\hypersetup{
    bookmarksnumbered=true,
    bookmarksopen=true,
    bookmarksopenlevel=3,
    colorlinks=true,
    allcolors=@hyperreflinkred,
    pdfinfo={
        Template.name={<%= name %>},
        Template.author={Xu Cheng <xucheng@me.com>},
        Template.category={<%= category.to_s %>},
        Template.date={<%= date %>}, % chktex 8
        Template.commit={<%= commit %>},
        Template.url={https://github.com/xu-cheng/latex},
    },
<% if category == :beamer %>
    pdfcenterwindow=true,
    pdfstartview={Fit},
    pdfpagemode={FullScreen},
    pdfpagelayout={SinglePage}
<% elsif category == :poster %>
    plainpages=false,
    pdfcenterwindow=true,
    pdfstartview={Fit},
    pdfpagemode={UseNone},
    pdfpagelayout={SinglePage}
<% else %>
    linktoc=page,
    plainpages=false,
    pdfstartview={XYZ null null 1},
    pdfpagemode={UseOutlines},
    pdfpagelayout={OneColumn}
<% end %>
}
\RequirePackage{bookmark}

% Math related packages
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsfonts}
\RequirePackage{mathrsfs}
\RequirePackage{latexsym}
<% if category != :beamer %>
\RequirePackage{bm}
<% end %>
\RequirePackage{fancynum}
\setfnumgsym{\,}
\RequirePackage[linesnumbered,ruled,vlined]{algorithm2e}
\SetVlineSkip{0pt}

% Caption related packages
\RequirePackage{caption}
\RequirePackage{subcaption}

% Figure related packages
\RequirePackage{graphicx}
\RequirePackage{tikz}
\RequirePackage{overpic}

% Table related packages
\RequirePackage{array}
\RequirePackage{tabu}
\RequirePackage{booktabs}
\RequirePackage{multirow}
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}

% Equation style
\allowdisplaybreaks[4]
\numberwithin{equation}{<%= top_level %>}

% Skip between equation and context
% Ref: https://tex.stackexchange.com/a/69678
\def\@setdisplayskip{
    \abovedisplayskip=0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip % chktex 1
    \abovedisplayshortskip=0pt plus 0.25\baselineskip % chktex 1
    \belowdisplayskip=0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip % chktex 1
    \belowdisplayshortskip=0.5\baselineskip plus 0.25\baselineskip minus 0.25\baselineskip % chktex 1
}
\xapptocmd\normalsize{\@setdisplayskip}{}{}

% Floating objects style
% Ref: https://liam0205.me/2017/04/30/floats-in-LaTeX-the-positioning-algorithm/
\RequirePackage{float}
\setlength{\intextsep}{0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip} % chktex 1
\setlength{\floatsep}{0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip} % chktex 1
\setlength{\textfloatsep}{0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip} % chktex 1
\setlength{\dblfloatsep}{0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip} % chktex 1
\setlength{\dbltextfloatsep}{0.75\baselineskip plus 0.15\baselineskip minus 0.45\baselineskip} % chktex 1
\renewcommand{\textfraction}{0.15}
\renewcommand{\topfraction}{0.85}
\renewcommand{\dbltopfraction}{0.85}
\renewcommand{\bottomfraction}{0.65}
\renewcommand{\floatpagefraction}{0.60}

% Caption style
\DeclareCaptionLabelFormat{@caplabel}{#1~#2}
\captionsetup{
<% if category == :beamer %>
    compatibility=false,
<% end %>
    labelformat=@caplabel,
    format=hang,
    labelsep=quad,
    skip=\baselineskip%
}

% Utility function
\RequirePackage{soul} % offers \hl
\def\email#1{
    \href{mailto:#1}{\texttt{#1}}
}
\long\def\eat#1{}
\long\def\todo#1{
    {\color{red} TODO:\ #1}
}
